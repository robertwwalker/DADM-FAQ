{
  "hash": "10072017bddcf10f2e64fba6e9be9cfb",
  "result": {
    "markdown": "---\ntitle: \"timetk is really, really handy\"\nauthor: \"Robert W. Walker\"\ndate: \"2021-03-24\"\ncategories: [R, time_series, tidy]\nimage: \"image.png\"\n---\n\n\n# timetk\n\nThe `timetk` or time toolkit package for R provides a glorious complementary fork to the `tsibble` adopted in the FPP 3 text [and the preceding `forecast` package built around `fpp2`].  If you want to know about time series data types, I cannot stress how useful and complete the vignette on time series coercion that is written into[the documentation for timetk](https://business-science.github.io/timetk/articles/TK00_Time_Series_Coercion.html)\n\n## wrangling\n\nWrangling is tidy and some of the things that you may have found frustrating about aggregation before may make more sense when shown using this approach.  For example, we needed effort to massage daily data on equities, that's a specific function of the indexing in a daily time series where markets are closed on weekends.  Time needs to be redefined.  [Questions like this get some attention here](https://business-science.github.io/timetk/articles/TK07_Time_Series_Data_Wrangling.html)\n\n## `condense_period`\n\nThis function allow you easily aggregate `data.frame` data with the declaration of a time variable.  Elsewhere, I have an example of pivoting data [from wide to long](../pivots/).  It is very handy.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nNWS <- read.csv(\n  url(\"https://www.weather.gov/source/pqr/climate/webdata/Portland_dailyclimatedata.csv\"), \n                skip=6, \n                na.strings = c(\"M\",\"-\", \"\")) %>% \n  rename(Variable = X) %>%\n  mutate(across(where(is.character), \n                ~str_remove(.x, \"/A\"))) %>%\n  filter(!(MO==1 & YR==2020))\nlibrary(magrittr)\n# I really like the magrittr %<>% pipe for updating data during cleaning\n# Start the daily data\nNWS.Daily <- NWS %>% select(-AVG.or.Total)\n# Rename the columns because Variable is actually X\nnames(NWS.Daily) <- c(\"YR\",\"MO\",\"Variable\",paste0(\"Day.\",1:31))\n# Create the daily data frame though it contains days that do not actually exist. \n# Every month nominally has 31 days.\nNWS.DF <- NWS.Daily %>% \n  pivot_longer(., cols=starts_with(\"Day.\"), names_to = \"Day\", values_to = \"value\") %>% \n  mutate(Day = str_remove(Day, \"Day.\"))\nNWS.DF %<>% pivot_wider(., names_from = \"Variable\", values_from = \"value\")\nNWS.DF %<>% mutate(date = as.Date(paste(MO,Day,YR,sep=\"-\"), format=\"%m-%d-%Y\"))\nNWS.DF$SN[NWS.DF$date==as.Date(\"1978-12-07\")] <- 0\nNWS.DF %<>% \n  mutate(PR = recode(PR, T = \"0.005\"), \n         SN = recode(SN, T = \"0.005\")) %>%\n  mutate(High = as.numeric(TX), \n         Low = as.numeric(TN), \n         Precipitation = as.numeric(PR), \n         Snow = as.numeric(SN)\n         ) %>%\n    select(date, High, Low, Precipitation, Snow)\nlibrary(kableExtra)\nhead(NWS.DF, n=40) %>% kable() %>% scroll_box(width=\"600px\", height=\"400px\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div style=\"border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:400px; overflow-x: scroll; width:600px; \"><table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;position: sticky; top:0; background-color: #FFFFFF;\"> date </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> High </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> Low </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> Precipitation </th>\n   <th style=\"text-align:right;position: sticky; top:0; background-color: #FFFFFF;\"> Snow </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-01 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-02 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-03 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-04 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-05 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-06 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-07 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-08 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-09 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-10 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-11 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-12 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-13 </td>\n   <td style=\"text-align:right;\"> 75 </td>\n   <td style=\"text-align:right;\"> 57 </td>\n   <td style=\"text-align:right;\"> 0.010 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-14 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n   <td style=\"text-align:right;\"> 0.005 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-15 </td>\n   <td style=\"text-align:right;\"> 64 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 0.005 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-16 </td>\n   <td style=\"text-align:right;\"> 72 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-17 </td>\n   <td style=\"text-align:right;\"> 72 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n   <td style=\"text-align:right;\"> 0.130 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-18 </td>\n   <td style=\"text-align:right;\"> 78 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-19 </td>\n   <td style=\"text-align:right;\"> 78 </td>\n   <td style=\"text-align:right;\"> 59 </td>\n   <td style=\"text-align:right;\"> 0.005 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-20 </td>\n   <td style=\"text-align:right;\"> 64 </td>\n   <td style=\"text-align:right;\"> 54 </td>\n   <td style=\"text-align:right;\"> 0.140 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-21 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 0.050 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-22 </td>\n   <td style=\"text-align:right;\"> 61 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-23 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n   <td style=\"text-align:right;\"> 0.630 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-24 </td>\n   <td style=\"text-align:right;\"> 57 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 1.030 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-25 </td>\n   <td style=\"text-align:right;\"> 57 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-26 </td>\n   <td style=\"text-align:right;\"> 57 </td>\n   <td style=\"text-align:right;\"> 38 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-27 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 37 </td>\n   <td style=\"text-align:right;\"> 0.005 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-28 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n   <td style=\"text-align:right;\"> 45 </td>\n   <td style=\"text-align:right;\"> 0.180 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-29 </td>\n   <td style=\"text-align:right;\"> 59 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 0.580 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-30 </td>\n   <td style=\"text-align:right;\"> 59 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 0.500 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-10-31 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0.250 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-01 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 40 </td>\n   <td style=\"text-align:right;\"> 0.170 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-02 </td>\n   <td style=\"text-align:right;\"> 53 </td>\n   <td style=\"text-align:right;\"> 38 </td>\n   <td style=\"text-align:right;\"> 0.020 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-03 </td>\n   <td style=\"text-align:right;\"> 47 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n   <td style=\"text-align:right;\"> 0.005 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-04 </td>\n   <td style=\"text-align:right;\"> 55 </td>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-05 </td>\n   <td style=\"text-align:right;\"> 51 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0.070 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-06 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0.280 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-07 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 0.850 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-08 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 42 </td>\n   <td style=\"text-align:right;\"> 0.290 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1940-11-09 </td>\n   <td style=\"text-align:right;\"> 48 </td>\n   <td style=\"text-align:right;\"> 35 </td>\n   <td style=\"text-align:right;\"> 0.020 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table></div>\n\n`````\n:::\n:::\n\n\n## Aggregating\n\nThis would normally be a pain; `timetk` makes it easy.  I want to aggregate them by the last period of whatever month it happens to be.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(timetk)\nNWS.Analysis.M <- NWS.DF %>% condense_period(., date, .period=\"1 month\", .side=\"end\")\n```\n:::\n\n\n## fpp3\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(fpp3)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ──────────────────────────────────────────── fpp3 0.4.0 ──\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ lubridate   1.9.0     ✔ feasts      0.3.0\n✔ tsibble     1.1.3     ✔ fable       0.3.2\n✔ tsibbledata 0.4.1     \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Conflicts ───────────────────────────────────────────────── fpp3_conflicts ──\n✖ lubridate::date()        masks base::date()\n✖ magrittr::extract()      masks tidyr::extract()\n✖ dplyr::filter()          masks stats::filter()\n✖ kableExtra::group_rows() masks dplyr::group_rows()\n✖ tsibble::intersect()     masks base::intersect()\n✖ tsibble::interval()      masks lubridate::interval()\n✖ dplyr::lag()             masks stats::lag()\n✖ magrittr::set_names()    masks purrr::set_names()\n✖ tsibble::setdiff()       masks base::setdiff()\n✖ tsibble::union()         masks base::union()\n```\n:::\n\n```{.r .cell-code}\nNWS.TS.M <- NWS.Analysis.M %>% mutate(YM=yearmonth(date)) %>% as_tsibble(index=YM)\nNWS.Analysis.M %>%\n  mutate(YM=yearmonth(date)) %>%\n  select(YM, High, Low) %>%\n  pivot_longer(c(High, Low)) %>%\n  mutate(Temperature=name) %>%\n  select(-name) %>%\n  as_tsibble(index=YM, key=Temperature) %>%\n  autoplot(value, alpha=0.3) + \n  labs(title=\"High and Low Temperatures in Portland, Oregon\",\n       x = \"Month\",\n       y = \"Temperature (F)\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}